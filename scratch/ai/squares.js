const delay=t=>new Promise(e=>setTimeout(e,t));class Squares extends Umpire{constructor(t=5){super(t),this.game=new DotsAndBoxesGame(t),this.gboard=this.game.getInitBoard(),this.score={2:0,1:0}}check_state(t=this.board){let e=!0,i=[0,0];for(let a=0;a<this.size;a++)for(let o=0;o<this.size;o++){let h=t.data[a][o],r=t%3;for(let n=0;n<4;n++)h%3!=r&&(r=0),h=Math.floor(h/3);r?i[r-1]++:e=!1}return e?s[0]>s[1]?1:-1:0}update(t,e){this.gboard=this.game.getNextState(this.gboard,(2==e?-1:1)*this.m,t)[0];let i=!1;if(t<this.size*(this.size+1)){let a=t%this.size,o=(t-a)/this.size,h;if(o>0){this.board.data[a][o-1]+=9*e,h=!0;for(let r=0;r<4;r++)Math.floor(this.board.data[a][o-1]/Math.ceil(Math.pow(3,r)))%3==0&&(h=!1);h&&0==Math.floor(this.board.data[a][o-1]/81%3)&&(this.board.data[a][o-1]+=81*e,this.score[e]++,$(`[row=${o-1}][col=${a}]`).text(this.score[e]),i=!0)}if(o<this.size){h=!0,this.board.data[a][o]+=e;for(let n=0;n<4;n++)Math.floor(this.board.data[a][o]/Math.ceil(Math.pow(3,n)))%3==0&&(h=!1);h&&0==Math.floor(this.board.data[a][o]/81%3)&&(this.board.data[a][o]+=81*e,this.score[e]++,$(`[row=${o}][col=${a}]`).text(this.score[e]),i=!0)}}else if(t<2*this.size*(this.size+1)){let l=(t-=this.size*(this.size+1))%(this.size+1),_=(t-l)/(this.size+1),c=!0;if(l>0){this.board.data[l-1][_]+=3*e,c=!0;for(let d=0;d<4;d++)0==Math.floor(this.board.data[l-1][_]/Math.ceil(Math.pow(3,d))%3)&&(c=!1);c&&0==Math.floor(this.board.data[l-1][_]/81%3)&&(this.board.data[l-1][_]+=81*e,this.score[e]++,$(`[row=${_}][col=${l-1}]`).text(this.score[e]),i=!0)}if(l<this.size){c=!0,this.board.data[l][_]+=27*e;for(let g=0;g<4;g++)0==Math.floor(this.board.data[l][_]/Math.ceil(Math.pow(3,g))%3)&&(c=!1);c&&0==Math.floor(this.board.data[l][_]/81%3)&&(this.board.data[l][_]+=81*e,this.score[e]++,$(`[row=${_}][col=${l}]`).text(this.score[e]),i=!0)}}return i}async challenge(t,e=Math.random()>.5?1:-1){this.board.reset(),this.m=e;for(let i=this.game.getValidMoves(this.gboard,1);i.length;i=this.game.getValidMoves(this.gboard,1),e*=-1){if(displayBoard(this.board),-1==e){thinking=!0,$(".cover").removeClass("d-none"),$(".cover").addClass("darken d-flex");let a=await t.move(this.game,this.gboard,-1);this.update(a,2)?(e*=-1,this.update(2*this.size*(this.size+1),1)):finishMove()}else{var o;let h=new Promise(t=>move_promise=t);switch((h=await h)[2]){case 0:o=this.update(h[0]+h[1]*this.size,1);break;case 2:o=this.update(h[0]+(h[1]+1)*this.size,1);break;case 3:o=this.update(h[0]+h[1]*(this.size+1)+(this.size+1)*this.size,1);break;case 1:o=this.update(h[0]+1+h[1]*(this.size+1)+(this.size+1)*this.size,1);break;default:console.log("default",h)}o&&(e*=-1),animateMove(umpire.board)}let r=this.check_state();if(displayBoard(this.board),0!=r)return endGame(),r}return displayBoard(this.board),endGame(),0}}class Board{constructor(t){this.n=t,this.pieces=Array(2*t+1).fill(Array(t+1).fill(0)).map(t=>[...t])}clone(t){return[...t].map(t=>[...t])}increase_score(t,e){let i=this.clone(this.pieces);i[1==e?0:1][i[0].length-1]+=t,this.pieces=i}is_pass_on(){let t=this.pieces;return t[2][t[0].length-1]}toggle_pass(t){let e=this.clone(this.pieces);e[2][e[0].length-1]=t,this.pieces=e}flatten(){let t=this.clone(this.pieces).map(t=>t.map(t=>+!t)),e=[];for(let i=0;i<=this.n;i++)t[i].pop(),e=e.concat(t[i]);for(let a=this.n+1;a<=2*this.n;a++)e=e.concat(t[a]);return e}get_legal_moves(t){let e=this.flatten();return e=e.concat([0]),this.is_pass_on()&&((e=Array(e.length)).fill(0),e[e.length-1]=1),e}has_legal_moves(){return this.flatten().reduce((t,e)=>t||e)}execute_move(t,e){let i,a,o=t<this.n*(this.n+1);o?(i=parseInt(t/this.n),a=t%this.n):(t-=this.n*(this.n+1),i=parseInt(t/(this.n+1))+this.n+1,a=t%(this.n+1));let h=this.clone(this.pieces);h[i][a]=1,this.pieces=this.clone(h);let r=Array(h.length).fill(0);h.map(t=>{t.push(0),t.unshift(0)});let n=[r];for(let l=0;l<=this.n;l++)h[l][h[l].length-1]=0,n.push(h[l]);n.push(r);let _=[r];for(let c=this.n+1;c<=2*this.n;c++)_.push(h[c]);_.push(r);let d=0,g,p,u,f;return g=0,p=0,u=0,f=0,o?(i++,a++,n[i+1][a]&&(p=_[i][a]&&_[i][a+1]),n[i-1][a]&&(g=_[i-1][a]&&_[i-1][a+1])):(i-=this.n,a++,_[i][a+1]&&(f=n[i][a]&&n[i+1][a]),_[i][a-1]&&(u=n[i][a-1]&&n[i+1][a-1])),d=g+p+u+f,this.increase_score(d,e),this.toggle_pass(+(d>0)),[g,p,u,f]}}class DotsAndBoxesGame{constructor(t){this.n=t}getInitBoard(){return new Board(this.n).pieces}getBoardSize(){return[2*this.n+1,this.n+1]}getActionSize(){return 2*(this.n+1)*this.n+1}getNextState(t,e,i){let a=new Board(this.n);a.pieces=a.clone(t);let o,h,r,n;return i==this.getActionSize()-1?a.pieces[2][a.pieces[2].length-1]=0:[o,h,r,n]=a.execute_move(i,e),[a.pieces,-e,o,h,r,n]}getValidMoves(t,e){let i=new Board(this.n);return i.pieces=t,i.get_legal_moves(e)}getGameEnded(t,e){let i=new Board(this.n);if(i.pieces=t,i.has_legal_moves())return 0;let a=t,o=a[0].length-1;return a[0][o]==a[1][o]?-1*e:a[0][o]>a[1][o]?1*e:-1*e}getCanonicalForm(t,e){if(t=new Board(this.n).clone(t),-1==e){let i=t[0].length-1,a=t[0][i];t[0][i]=t[1][i],t[1][i]=a}return t}predict(t,e){let i=(e=new Board(this.n).clone(e))[0].length-1,a=e[0][i],o=e[1][i],h=this.n*this.n;e[0][i]=-((a-o-h)/(-1*h-h)*1)+1,e[1][i]=0;let r=this.getBoardSize();return r.unshift(1),t.predict(tf.tensor(e).reshape(r))}stringRepresentation(t){return t.toString()}}class Player{constructor(t){tf.loadLayersModel("model/model.json?v=1").then(e=>this.mcts=new MCTS(t.game,e,{cpuct:1,numMCTSSims:50}))}async move(t,e,i){for(;void 0===this.mcts;)await new Promise(t=>setTimeout(t,100));return(await this.mcts.getActionProb(t.getCanonicalForm(e,i))).indexOf(1)}}